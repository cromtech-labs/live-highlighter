<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Scrolling Test - Live Highlighter</title>
    <style>
      :root {
        --bg-page: #f5f5f5;
        --bg-card: #ffffff;
        --bg-subtle: #f8f9fa;
        --text-primary: #202124;
        --text-secondary: #5f6368;
        --accent: #1a73e8;
        --border: #dadce0;
        --shadow: rgba(0, 0, 0, 0.1);
      }

      [data-theme="dark"] {
        --bg-page: #202124;
        --bg-card: #292a2d;
        --bg-subtle: #3c4043;
        --text-primary: #e8eaed;
        --text-secondary: #9aa0a6;
        --accent: #8ab4f8;
        --border: #5f6368;
        --shadow: rgba(0, 0, 0, 0.3);
      }

      body {
        font-family: "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: var(--bg-page);
        transition: background-color 0.3s, color 0.3s;
      }
      .header {
        background: var(--bg-card);
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px var(--shadow);
        position: relative;
      }
      h1 {
        color: var(--accent);
        margin: 0 0 10px;
      }
      .header p {
        color: var(--text-primary);
      }
      .header strong {
        color: var(--text-primary);
      }
      .container {
        background: var(--bg-card);
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow);
        overflow: hidden;
      }
      .virtual-list {
        height: 600px;
        overflow-y: auto;
        position: relative;
        border: 1px solid var(--border);
      }
      .virtual-content {
        position: relative;
      }
      .list-item {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        position: absolute;
        left: 0;
        right: 0;
        background: var(--bg-card);
      }
      .list-item:hover {
        background: var(--bg-subtle);
      }
      .item-title {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 5px;
      }
      .item-desc {
        color: var(--text-secondary);
        font-size: 13px;
      }
      .stats {
        padding: 15px 20px;
        background: var(--bg-subtle);
        border-top: 1px solid var(--border);
        font-size: 13px;
        color: var(--text-secondary);
      }

      .theme-toggle {
        position: absolute;
        top: 30px;
        right: 30px;
        background: var(--bg-subtle);
        border: 1px solid var(--text-secondary);
        color: var(--text-primary);
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .theme-toggle:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Virtual Scrolling Test</h1>
      <button class="theme-toggle" id="themeToggle">üåô Dark Mode</button>
      <p>
        This page implements virtual scrolling where DOM nodes are recycled as
        you scroll. Live Highlighter should re-highlight content as it becomes
        visible.
      </p>
      <p>
        <strong>Test keywords:</strong> error, success, resource, tags, kv-,
        data
      </p>
    </div>

    <div class="container">
      <div id="virtualList" class="virtual-list"></div>
      <div class="stats">
        <span id="stats"
          >Scroll to test highlighting with virtual scrolling...</span
        >
      </div>
    </div>

    <script>
      // Theme toggle functionality
      const themeToggle = document.getElementById('themeToggle');
      const html = document.documentElement;

      // Load saved theme or default to light
      const savedTheme = localStorage.getItem('test-theme') || 'light';
      html.setAttribute('data-theme', savedTheme);
      updateToggleButton(savedTheme);

      themeToggle.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('test-theme', newTheme);
        updateToggleButton(newTheme);
      });

      function updateToggleButton(theme) {
        themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
      }

      // Virtual scrolling implementation
      const ITEM_HEIGHT = 80;
      const TOTAL_ITEMS = 10000;
      const BUFFER_SIZE = 5;

      const listEl = document.getElementById("virtualList");
      const statsEl = document.getElementById("stats");

      // Sample data with keywords
      const keywords = [
        "error",
        "success",
        "resource",
        "tags",
        "kv-",
        "data",
        "api",
        "service",
      ];
      const templates = [
        "Processing request #INDEX: error handling enabled, success rate: 99.9%",
        "Resource #INDEX allocated with tags: production, kv-store enabled",
        "Data sync #INDEX completed successfully with resource optimization",
        "API call #INDEX: no errors, success response with data payload",
        "Service #INDEX running, kv-config loaded, tags applied",
        "Error recovery for resource #INDEX: success, data integrity verified",
        "Tags management #INDEX: kv-pairs updated, success confirmed",
        "Request #INDEX processed: no error, resource available, data ready",
      ];

      function getItemData(index) {
        const template = templates[index % templates.length];
        return {
          title: `Item ${index + 1}`,
          description: template.replace("#INDEX", index + 1),
        };
      }

      let scrollTop = 0;
      let visibleStart = 0;
      let visibleEnd = 0;

      function updateVisibleItems() {
        const containerHeight = listEl.clientHeight;
        const scrollTop = listEl.scrollTop;

        // Calculate visible range with buffer
        const start = Math.max(
          0,
          Math.floor(scrollTop / ITEM_HEIGHT) - BUFFER_SIZE
        );
        const end = Math.min(
          TOTAL_ITEMS,
          Math.ceil((scrollTop + containerHeight) / ITEM_HEIGHT) + BUFFER_SIZE
        );

        // Only update if range changed
        if (start === visibleStart && end === visibleEnd) return;

        visibleStart = start;
        visibleEnd = end;

        // Clear and re-render visible items
        const content = document.createElement("div");
        content.className = "virtual-content";
        content.style.height = `${TOTAL_ITEMS * ITEM_HEIGHT}px`;

        for (let i = start; i < end; i++) {
          const data = getItemData(i);
          const item = document.createElement("div");
          item.className = "list-item";
          item.style.top = `${i * ITEM_HEIGHT}px`;
          item.style.height = `${ITEM_HEIGHT}px`;
          item.innerHTML = `
          <div class="item-title">${data.title}</div>
          <div class="item-desc">${data.description}</div>
        `;
          content.appendChild(item);
        }

        listEl.innerHTML = "";
        listEl.appendChild(content);

        // Update stats
        statsEl.textContent = `Showing items ${
          start + 1
        }-${end} of ${TOTAL_ITEMS.toLocaleString()} (scroll position: ${Math.round(
          scrollTop
        )}px)`;
      }

      // Handle scroll events
      let scrollTimeout;
      listEl.addEventListener("scroll", () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateVisibleItems, 50);
      });

      // Initial render
      updateVisibleItems();
    </script>
  </body>
</html>
